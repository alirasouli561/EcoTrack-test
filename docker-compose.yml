# ============================================================================
# DOCKER-COMPOSE.YML - ORCHESTRATION ECOTRACK (6 microservices + gateway)
# ============================================================================
#
# PRINCIPES:
# - Un SEUL docker-compose pour orchestrer les services applicatifs.
# - Chaque microservice possède son Dockerfile (build multi-stage recommandé).
# - La base PostgreSQL est HÉBERGÉE À DISTANCE (pas de conteneur Postgres ici).
# - Les secrets (mots de passe, JWT) doivent être fournis via un fichier .env
#   (non commité) ou un gestionnaire de secrets.
# - Les services non encore prêts sont placés sous "profiles" pour ne pas
#   casser le build tant que leurs dossiers n'existent pas.
#
# COMMANDES UTILES:
#   docker compose up -d --build           # Lancer
#   docker compose down                    # Arrêter
#   docker compose ps                      # Statut
#   docker compose logs -f service-users   # Logs
# ============================================================================

services:
  # =========================================================================
  # API GATEWAY (port 3000)
  # =========================================================================
  api-gateway:
    build:
      context: ./services/api-gateway
      dockerfile: Dockerfile
    container_name: ecotrack-api-gateway
    environment:
      GATEWAY_PORT: 3000
      USERS_PORT: 3010
      USERS_SERVICE_URL: http://service-users:3010
      CONTAINERS_SERVICE_URL: http://service-containers:3011
      ROUTES_SERVICE_URL: http://service-routes:3012
      IOT_SERVICE_URL: http://service-iot:3013
      GAMIFICATIONS_SERVICE_URL: http://service-gamifications:3014
      ANALYTICS_SERVICE_URL: http://service-analytics:3015
      GATEWAY_RATE_WINDOW_MS: ${GATEWAY_RATE_WINDOW_MS:-60000}
      GATEWAY_RATE_MAX: ${GATEWAY_RATE_MAX:-100}
      NODE_ENV: production
    ports:
      - "3000:3000"
    depends_on:
      service-users:
        condition: service_healthy
    networks:
      - ecotrack
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "healthcheck.cjs"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =========================================================================
  # SERVICE-USERS (port 3010) - Exemple complet
  # =========================================================================
  service-users:
    build:
      context: ./services/service-users
      dockerfile: Dockerfile
    container_name: ecotrack-service-users
    environment:
      APP_PORT: 3010
      DATABASE_URL: ${DATABASE_URL_USERS:-postgresql://neondb_owner:npg_mbPakcGQ7U6V@ep-blue-credit-agbgkufh.c-2.eu-central-1.aws.neon.tech/neondb?sslmode=require}
      JWT_SECRET: ${JWT_SECRET:-change_me_access}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-change_me_refresh}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-24h}
      JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN:-7d}
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-60000}
      RATE_LIMIT_REQUESTS: ${RATE_LIMIT_REQUESTS:-100}
      NODE_ENV: production
    ports:
      - "3010:3010"
    networks:
      - ecotrack
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "healthcheck.cjs"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =========================================================================
  # SERVICE-CONTAINERS (port 3011) - profil désactivé tant que le dossier n'existe pas
  # =========================================================================
  service-containers:
    profiles: [placeholder]
    build:
      context: ./service-containers
      dockerfile: Dockerfile
    container_name: ecotrack-service-containers
    environment:
      APP_PORT: 3011
      DATABASE_URL: ${DATABASE_URL_CONTAINERS:-postgresql://neondb_owner:npg_mbPakcGQ7U6V@ep-blue-credit-agbgkufh.c-2.eu-central-1.aws.neon.tech/neondb?sslmode=require}
      NODE_ENV: production
    ports:
      - "3011:3011"
    networks:
      - ecotrack
    restart: unless-stopped

  # =========================================================================
  # SERVICE-ROUTES (port 3012)
  # =========================================================================
  service-routes:
    profiles: [placeholder]
    build:
      context: ./service-routes
      dockerfile: Dockerfile
    container_name: ecotrack-service-routes
    environment:
      APP_PORT: 3012
      DATABASE_URL: ${DATABASE_URL_ROUTES:-postgresql://neondb_owner:npg_mbPakcGQ7U6V@ep-blue-credit-agbgkufh.c-2.eu-central-1.aws.neon.tech/neondb?sslmode=require}
      NODE_ENV: production
    ports:
      - "3012:3012"
    networks:
      - ecotrack
    restart: unless-stopped

  # =========================================================================
  # SERVICE-IOT (port 3013)
  # =========================================================================
  service-iot:
    profiles: [placeholder]
    build:
      context: ./service-iot
      dockerfile: Dockerfile
    container_name: ecotrack-service-iot
    environment:
      APP_PORT: 3013
      DATABASE_URL: ${DATABASE_URL_IOT:-postgresql://neondb_owner:npg_mbPakcGQ7U6V@ep-blue-credit-agbgkufh.c-2.eu-central-1.aws.neon.tech/neondb?sslmode=require}
      NODE_ENV: production
    ports:
      - "3013:3013"
    networks:
      - ecotrack
    restart: unless-stopped

  # =========================================================================
  # SERVICE-GAMIFICATIONS (port 3014)
  # =========================================================================
  service-gamifications:
    build:
      context: ./services/service-gamifications
      dockerfile: Dockerfile
    container_name: ecotrack-service-gamifications
    environment:
      GAMIFICATIONS_PORT: 3014
      GAMIFICATIONS_DATABASE_URL: ${DATABASE_URL_GAMIFICATIONS:-postgresql://neondb_owner:npg_mbPakcGQ7U6V@ep-blue-credit-agbgkufh.c-2.eu-central-1.aws.neon.tech/neondb?sslmode=require}
      NODE_ENV: production
    ports:
      - "3014:3014"
    networks:
      - ecotrack
    restart: unless-stopped

  # =========================================================================
  # SERVICE-ANALYTICS (port 3015)
  # =========================================================================
  service-analytics:
    profiles: [placeholder]
    build:
      context: ./service-analytics
      dockerfile: Dockerfile
    container_name: ecotrack-service-analytics
    environment:
      APP_PORT: 3015
      DATABASE_URL: ${DATABASE_URL_ANALYTICS:-postgresql://neondb_owner:npg_mbPakcGQ7U6V@ep-blue-credit-agbgkufh.c-2.eu-central-1.aws.neon.tech/neondb?sslmode=require}
      NODE_ENV: production
    ports:
      - "3015:3015"
    networks:
      - ecotrack
    restart: unless-stopped

  # =========================================================================
  # JOB D'IMPORT SCHEMA (PostgreSQL Neon)
  # =========================================================================
  db-migrate:
    profiles: [migrate]
    image: postgres:16-alpine
    environment:
      DATABASE_URL: ${DATABASE_URL_USERS:-postgresql://neondb_owner:npg_mbPakcGQ7U6V@ep-blue-credit-agbgkufh.c-2.eu-central-1.aws.neon.tech/neondb?sslmode=require}
    volumes:
      - ./service-users/sql:/sql:ro
    entrypoint: ["sh", "-c", "psql \"$DATABASE_URL\" -f /sql/EcoTrack.sql"]
    networks:
      - ecotrack

# ============================================================================
# RÉSEAU (bridge Docker)
# ============================================================================
networks:
  ecotrack:
    driver: bridge
